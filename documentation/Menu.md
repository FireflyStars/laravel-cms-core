# The Menu

Each module may have a Menu Presence (or any number of them). 
Once a module is added to the CMS, its menu presence will automatically be applied.

For example, if you include the [simple ACL Module](https://github.com/czim/laravel-cms-acl-module) to your CMS,
it will make an access control menu item appear: an expandable group with links to lists of users and roles. 

Note that a menu presence is not required for a module 
(for instance, no presence should be set if the module only offers backend or API-based functionality).


## Order of Menu Items

Unless a specific order is configured, menu items will be placed in the order in which their modules are loaded.
You can change this by changing the order of items in the `cms-modules.modules` configuration array.

Alternatively, for more control, the order of menu presences may be determined by adding module keys to 
the `cms-modules.menu.modules` configuration array.
You can do so by adding module key strings to this array, in the order that they should appear in the menu.

For example, the models module may order a Comment model before a Post model in the menu. 
Reversing this can be done by setting `cms-modules.menu.modules` as follows: 

```php
<?php
    'menu' => [
        
        'modules' => [
            'models.app-models.post',
            'models.app-models.comment',
        ]
    ]
```

Note: you can get a list of available module keys with `php artisan cms:modules:show --keys`.


## Defining a Menu Layout

If adjusting the order itself is not enough, a menu layout with nested groups may optionally be defined. 
This way, you can create a menu tree to any desired depth to give the menu any structure you want.

The layout is defined in the `cms-modules.menu.layout` configuration array.

(If you are already familiar with the way form layouts work in the [Models Module](https://github.com/czim/laravel-cms-models),
note that menu layouts are defined mostly the same way.)

For example, to create a single group and assign some modules to it:

```php
<?php
    'menu' => [
        
        'layout' => [
            'some-group' => [
                'label'    => 'Some Group',
                'icon'     => 'home',
                'children' => [
                    'models.app-models.post',
                    'models.app-models.comment',
                ]
            ]
        ],
    ]
```

The fields available for menu groups in the layout array are:

- `id` (string)
- `label` (string)
- `label_translated` (string)
- `icon` (string)
- `children` (array) (child module keys and/or nested groups)

For more information, see the [Menu Presences](#menu-presences) section below.

Groups may have children to any depth. The only limit is what your CMS theme supports.

```php
<?php
    'menu' => [
        
        'layout' => [
            'some-group' => [
                'label'    => 'Some Group',
                'icon'     => 'home',
                'children' => [
                    'models.app-models.post',
                    [
                        'label'    => 'Some Group',
                        'icon'     => 'home',
                        'children' => [
                            'models.app-models.comment',
                        ]
                    ]
                ]
            ]
        ],
    ]
```

Any module not listed in the layout will automatically be added at the top menu level, *after* layout defined presences.

Empty groups will not appear on the menu.
This includes groups that exclusively contain menu presences in them that the user currently has no permission to see or use.

Note: you can get a list of available module keys with `php artisan cms:modules:show --keys`.


## Hiding Items from the Menu

Any module that has a menu presence will automatically be included in the menu.

To override this and disable a module from having its menu presence appear, add its module key to the `cms-modules.menu.modules`
configuration array with a value of `false`:

```php
<?php
    'menu' => [
        
        'modules' => [
            // This module will still work, but will not appear in the menu
            'models.app-models.post' => false,
        ]
    ]
```

Note that if you disable a module's presence this way, its key must not be used in the `layout`
(doing so will an `UnexpectedValueException`).

If you want to modify or replace, rather than disable a module's menu presence, read on.


## Menu Presences

A [Menu Presence](https://github.com/czim/laravel-cms-core/blob/master/src/Support/Data/MenuPresence.php) describes
the way a module should appear in the menu.

In most cases, presences will be generated by CMS modules and will not require manual configuration.
This reference is intended for advanced tinkering or customization of menu presences.

Presence attributes are as follows:

- `type` (string), *required*  
    The kind of presence: `'group'`, `'action'`, `'link'`.  
    See the list below for further information.

- `id` (string)  
    An identifier for the presence. This will be used as the HTML `id` attribute for in the menu view partial. 

- `action` (string)  
    Indicates what (CMS) action should be taken when a user clicks the presence label.
    Required for type `'action'` and `'link'`.  
    For type `action`, this should be a (fully prefixed) route name.  
    For type `link`, this should be a URI.  

- `label` (string)  
    A string to show as-is as the presence label.
    Not used if an available `label_translated` key is set.

- `label_translated` (string)  
    A translation key to use for displaying the presence label.
    If set, the `label` value is ignored, *unless* no translation has been set.

- `permissions` (string or array of strings)  
    One or more permissions that are required if a presence is to be displayed for a user.
    If more than one, *all* permissions are required for display.

- `parameters` (array)  
    An array with key-value pairs that should be passed along as parameters for the `action` route.
    This may be used to set some (hard-coded) parameters, which may help to differentiate between navigation links used.

- `icon` (string)  
    An indicator that may allow the CMS theme to draw an icon in front of the presence label text.  
    For the standard CMS theme, [Font Awesome](http://fontawesome.io/icons) class names are supported,
    without the 'fa-' prefix (f.i.: `'home'` for 'fa-home').

- `children` (array of menu presence definitions)  
    Only used for type `group`. 
    A list of presence definitions that should be nested as children under this group presence. 


The available presence `type` values are:

- `group`: An expandable group entity that may be the parent of further nested menu presences.
- `action`: A (CMS) route reference to module pages.
- `link`: A simple hyperlink to be displayed as-is.
- `html`: *not currently used*, may be implemented later for including custom HTML content in the menu.


## Overriding Menu Presences

It is possible to completely override menu presences as defined by CMS modules.

Each menu module configuration array in `cms-modules.menu.modules` may have a presence override:

```php
<?php
    'menu' => [
        
        'modules' => [
            
            'models.app-models.post' => [
                'presence' => [
                    'label'            => 'Employees',
                    'type'             => \Czim\CmsCore\Support\Enums\MenuPresenceType\MenuPresenceType::ACTION,
                    'action'           => 'cms::models.model.app-models-employee.index',
                    'parameters'       => [
                        'home' => true,
                    ],
                    'permissions'      => [
                        'models.app-models-employee.*',
                    ],
                ]
            ],            
        ]
    ]
```

This may be mixed in the `modules` array with module key strings, as long as no module key appears more than once.

This is not recommended unless you have a solid understanding of how the 
[menu presence data objects](https://github.com/czim/laravel-cms-core/blob/master/src/Support/Data/MenuPresence.php) work, 
as well as how route names and permissions are identified.

Keep in mind that `php artisan route:list` may help in getting a clear view of what actions, route names and permissions are available.

Note that this approach is fully compatible with any `group` assignment.


## Caching

The menu layout may be cached to speed up loading of CMS pages.

Caching can be enabled or disabled by setting the `cms-modules.menu.cache` with a boolean value.
It is recommended to leave caching disabled while configuring the CMS.

When enabled, the cache is automatically filled whenever it is found empty. 

Changes are not automatically detected, the cache must be flushed when the layout is changed or modules are added.

To flush the cache manually, use this artisan command:

```bash
php artisan cms:menu:clear
```


## Debugging

When building menus, the `cms:menu:show` command may be helpful:

This will print the currently configured menu structure to the console: 

```bash
php artisan cms:menu:show
```

This is mainly useful for figuring out how menu items are grouped regardless of active permissions.  
It also helps by showing the translation keys that you may set to localize your menu items.


It should look something like this:

```
Configured groups:

  Group (key: some-group)
  Label       : group display name
  Children :

    Action
    Label       : Testing action
    Action      : testing::index
    Permissions : do.something

    Action
    Label       : Categories
    Transl. key : models.name.categories (nl unset)
    Action      : cms::models.model.app-models-category.index
    Permissions : models.app-models-category.*


Unassigned to configured groups:

  Group
  Label       : Access Control
  Children :

    Action
    Label       : Users
    Action      : cms::acl.users.index
    Permissions : acl.users.show
```

